--1 - Generar una función que retorne cuantos años tiene una persona.

CREATE OR REPLACE FUNCTION 
EDAD_FTC(PERSONA PERSONS.PERSONS_ID%TYPE)
RETURN VARCHAR
IS
VAR_BIRTHDAY DATE;
FECHA_ACTUAL DATE;
EDAD NUMBER(2);
BEGIN
SELECT BIRTHDATE INTO VAR_BIRTHDAY FROM PERSONS WHERE PERSONS_ID= PERSONA ;
FECHA_ACTUAL:=SYSDATE;
EDAD:= (FECHA_ACTUAL-VAR_BIRTHDAY)/365;
RETURN 'ID_PERSONA: '||PERSONA||' |EDAD: ' ||EDAD;
END;

SELECT EDAD_FTC(319) FROM DUAL;



/*2 - los niños y viejos y enfermos no pueden trabajar en la mina. por ello cree un trigger que
sea capaz de garantizar que ningún empleado viole esas restricciones.
Nota: niño es considerado inferior a 12 años y un viejo es alguien mayor de 70 años
Recuerda que no se admiten personas enfermas.*/

CREATE OR REPLACE TRIGGER TR_REST_MINA
BEFORE INSERT OR UPDATE ON workers for each row
declare
var_edad_persona date;
fecha_actual date;
edad number(2);
VAR_ESTADO NUMBER;
BEGIN
select birthdate into var_edad_persona from persons where persons_id=:new.persons_id;
SELECT DIAGNOSTICS_ID INTO VAR_ESTADO FROM PERSONS_MEDICAL_CHECK WHERE PERSONS_ID=:NEW.PERSONS_ID;
fecha_actual:=sysdate;
EDAD:= (FECHA_ACTUAL-VAR_edad_persona)/365;
CASE
WHEN edad<12 OR EDAD>70 then
RAISE_APPLICATION_ERROR(-20001,'En la mina no se permiten niños ni ancianos');

WHEN VAR_ESTADO !=1 THEN
RAISE_APPLICATION_ERROR(-20001,'En la mina no se permiten enfermos o con deficiencias');
end CASE;
end;


/*4 - crear un cursor que muestre el id, nombre, apellido, fecha de nacimiento de todas las
mujeres que trabajan en una mina, la mina debe ser indicada por entrada de teclado*/

CREATE OR REPLACE PROCEDURE PRC_4
(MINA MINES.MINE_NAME%TYPE )
AS
BEGIN
FOR I IN(SELECT P.PERSONS_ID AS PER_, P.NAME AS NAME_, P.LASTNAME AS LAST_, P.BIRTHDATE AS BIRTH_
FROM PERSONS P 
INNER JOIN WORKERS W ON P.PERSONS_ID = W.PERSONS_ID 
INNER JOIN MINES M ON W.MINES_ID = M.MINES_ID 
WHERE LOWER(M.MINE_NAME) = LOWER(MINA) AND P.SEX = 'F') LOOP
DBMS_OUTPUT.PUT_LINE('ID_MUJER: '||I.PER_||' |NOMBRE: '||I.NAME_||' |APELLIDOS: '||I.LAST_||' |FECHA_NACIMIENTO: '||I.BIRTH_);
END LOOP;
END;

EXECUTE PRC_4('&mina')

